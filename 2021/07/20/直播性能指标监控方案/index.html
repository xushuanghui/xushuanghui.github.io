<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>直播性能指标监控方案 | xushuanghui</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="一、数据收集完整的直播环节：采集、预处理、编码、推流、（传输、转码、分发）、拉流、解码、播放  主播和观众端各自每10秒向服务器打点。 服务器接收到打点信息，为前端监控页面实时统计客户端直播播放情况。  1、主播端 摄像头（分辨率、帧率、机型）–&gt; 视频预处理（cpu占用、内存占用）–&gt; 编码（视频质量、帧率）–&gt; 码率自适应（码率、丢帧数、卡顿数）–&gt; 地理位置、服务器的">
<meta property="og:type" content="article">
<meta property="og:title" content="直播性能指标监控方案">
<meta property="og:url" content="http://example.com/2021/07/20/%E7%9B%B4%E6%92%AD%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88/index.html">
<meta property="og:site_name" content="xushuanghui">
<meta property="og:description" content="一、数据收集完整的直播环节：采集、预处理、编码、推流、（传输、转码、分发）、拉流、解码、播放  主播和观众端各自每10秒向服务器打点。 服务器接收到打点信息，为前端监控页面实时统计客户端直播播放情况。  1、主播端 摄像头（分辨率、帧率、机型）–&gt; 视频预处理（cpu占用、内存占用）–&gt; 编码（视频质量、帧率）–&gt; 码率自适应（码率、丢帧数、卡顿数）–&gt; 地理位置、服务器的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/Users/xushuanghui/Library/Application%20Support/typora-user-images/image-20220830173952538.png">
<meta property="article:published_time" content="2021-07-20T09:43:52.000Z">
<meta property="article:modified_time" content="2023-04-13T10:34:27.663Z">
<meta property="article:author" content="xushuanghui">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/Users/xushuanghui/Library/Application%20Support/typora-user-images/image-20220830173952538.png">
  
    <link rel="alternate" href="/atom.xml" title="xushuanghui" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">xushuanghui</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-直播性能指标监控方案" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/07/20/%E7%9B%B4%E6%92%AD%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88/" class="article-date">
  <time class="dt-published" datetime="2021-07-20T09:43:52.000Z" itemprop="datePublished">2021-07-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      直播性能指标监控方案
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一、数据收集"><a href="#一、数据收集" class="headerlink" title="一、数据收集"></a>一、数据收集</h2><p>完整的直播环节：采集、预处理、编码、推流、（传输、转码、分发）、拉流、解码、播放</p>
<ol>
<li>主播和观众端各自每10秒向服务器打点。</li>
<li>服务器接收到打点信息，为前端监控页面实时统计客户端直播播放情况。</li>
</ol>
<h3 id="1、主播端"><a href="#1、主播端" class="headerlink" title="1、主播端"></a>1、主播端</h3><ul>
<li>摄像头（分辨率、帧率、机型）–&gt; 视频预处理（cpu占用、内存占用）–&gt; 编码（视频质量、帧率）–&gt; 码率自适应（码率、丢帧数、卡顿数）–&gt; 地理位置、服务器的IP</li>
</ul>
<h3 id="2、播放端"><a href="#2、播放端" class="headerlink" title="2、播放端"></a>2、播放端</h3><ul>
<li><p>cdn边缘节点（节点运营商、地理位置、ping值）–&gt; 发送端至接收端延迟 –&gt; 接收缓冲（开播buffer长度、卡顿次数、卡顿时长）–&gt; 视频解码（帧率）–&gt; 播放（首帧时间）</p>
</li>
<li><p>播放失败的时候，上报错误信息和原因</p>
<span id="more"></span></li>
</ul>
<h2 id="二、直播性能指标建立"><a href="#二、直播性能指标建立" class="headerlink" title="二、直播性能指标建立"></a>二、直播性能指标建立</h2><ul>
<li>帧率：正常来说每秒15帧以上的视频流才能保证观看的流畅度，常规推流如果 FPS 在10帧以下，观众就会明显的感到画面卡顿</li>
<li></li>
</ul>
<h3 id="1、技术指标："><a href="#1、技术指标：" class="headerlink" title="1、技术指标："></a>1、技术指标：</h3><ul>
<li>房间故障，包括卡顿、丢帧、音视频不同步等。</li>
<li>分地域统计数据端到端延迟平均情况。</li>
<li>统计实时整体卡顿率（出现卡顿的在线用户数&#x2F;在线总用户数*100%，通过此指标可以衡量当前卡顿影响的人群范围）。</li>
<li>统计人均卡顿次数（在线卡顿总次数&#x2F;在线用户数，通过此指标可以从卡顿频次上衡量整体的卡顿严重程度）。</li>
</ul>
<h3 id="2、用户体验指标："><a href="#2、用户体验指标：" class="headerlink" title="2、用户体验指标："></a>2、用户体验指标：</h3><ul>
<li>次均观看时长</li>
<li>在线人数</li>
<li>看完播率</li>
<li>用户评论卡顿数（用户在评论区打出，“卡”等相关意义字符）</li>
</ul>
<h2 id="三、视频直播卡顿原因、优化"><a href="#三、视频直播卡顿原因、优化" class="headerlink" title="三、视频直播卡顿原因、优化"></a>三、视频直播卡顿原因、优化</h2><p>卡顿的原因主要有三种：</p>
<ul>
<li><p><strong>原因1：上传阻塞</strong></p>
</li>
<li><p><strong>原因2：推流帧率太低</strong></p>
</li>
<li><p><strong>原因3：下行不佳</strong></p>
<p>80%以上的直播间卡顿问题，均是由于主播端上传阻塞所致。</p>
</li>
</ul>
<h3 id="1-上传阻塞的评判"><a href="#1-上传阻塞的评判" class="headerlink" title="1. 上传阻塞的评判"></a>1. 上传阻塞的评判</h3><ul>
<li><strong>1.1：BITRATE 与 NET_SPEED 的关系</strong><br>BITRATE( &#x3D; VIDEO_BITRATE + AUDIO_BITRATE ) 指的是编码器每秒产生了多少音视频数据要推出去，NET_SPEED 指的是每秒钟实际推出了多少数据，所以如果 BITRATE &#x3D;&#x3D; NET_SPEED 的情况是常态，则推流质量会非常良好；而如果 BITRATE &gt;&#x3D; NET_SPEED 这种情况的持续时间比较长，推流质量就很难有什么保障。</li>
<li><strong>1.2：CACHE_SIZE 和 DROP_CNT 的数值</strong><br>BITRATE &gt;&#x3D; NET_SPEED 的情况一旦出现，编码器产生的音视频数据就会在主播的手机上积压起来，积压的严重程度以 CACHE_SIZE 这个状态值展示出来，如果 CACHE_SIZE 超过警戒线，SDK 会主动丢弃一些音视频数据，从而触发 DROP_CNT 的增长。下图所示就是一个典型的上行阻塞，途中 CACHE_SIZE 始终在<strong>红色警戒线</strong>以上，说明上行网络不足以满足数据的传输需求，也就是上行阻塞严重</li>
</ul>
<h3 id="2-上传阻塞优化方案"><a href="#2-上传阻塞优化方案" class="headerlink" title="2. 上传阻塞优化方案"></a>2. 上传阻塞优化方案</h3><ul>
<li><p><strong>2.1 主动提示主播</strong></p>
</li>
<li><p><strong>2.2 合理的编码设置</strong></p>
<p>分辨率：540 * 960，码率：1200kbps</p>
</li>
</ul>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="3-1-帧率太低的评判"><a href="#3-1-帧率太低的评判" class="headerlink" title="3.1 帧率太低的评判"></a>3.1 帧率太低的评判</h3><p>通过直播 LivePushListener 的 <strong>VIDEO_FPS</strong> 的状态数据，我们可以获得当前推流的视频帧率。正常来说每秒15帧以上的视频流才能保证观看的流畅度，常规推流如果 FPS 在10帧以下，观众就会明显的感到画面卡顿</p>
<h3 id="3-针对性优化方案"><a href="#3-针对性优化方案" class="headerlink" title="3. 针对性优化方案"></a>3. 针对性优化方案</h3><ul>
<li><strong>3.1 观察 CPU_USAGE 的大小</strong></li>
</ul>
<p>通过直播 SDK 的 LivePushListener 的 <strong>CPU_USAGE</strong> 的状态数据，我们可以获得<strong>当前推流 SDK 的 CPU 占用情况</strong>和<strong>当前系统的 CPU 占用情况</strong>。如果当前系统的整体 CPU 使用率超过80%，那么视频的采集和编码都会受到影响，无法正常发挥作用；如果 CPU 使用率达到100%，那么主播端本身就已经很卡，观众端要有流畅的观看体验显然是不可能的</p>
<ul>
<li><strong>2.3 不盲目追高分辨率</strong><br>过高的视频分辨率并不一定能带来清晰的画质：首先，较高的分辨率要配合较高的码率才能发挥效果，低码率高分辨的清晰度很多时候比不上高码率低分辨率。其次，像1280 x 720这样的分辨率在平均5寸左右的手机屏幕上并不能看出优势，要想跟960 x 540的分辨率拉开差距，只有在 PC 上全屏观看才能有明显的感官差异。但较高的分辨率会显著提升 SDK 的 CPU 使用率，因此常规情况下推荐使用 直播 SDK 中 LivePusher 的 <a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/454/7885#7.-.E8.AE.BE.E5.AE.9A.E7.94.BB.E9.9D.A2.E6.B8.85.E6.99.B0.E5.BA.A6">setVideoQuality</a> 设置<strong>高清</strong>档即可，盲目追高分辨率有可能达不到预期的目标。</li>
<li><strong>2.4 适当使用硬件加速</strong><br>现在的智能手机都支持硬件编码来降低视频编码对 CPU 的依赖，如果您发现您的 App 的 CPU 使用率过高，可以开启硬件编码来降低 CPU 使用率</li>
</ul>
<h3 id="4、优化播放端"><a href="#4、优化播放端" class="headerlink" title="4、优化播放端"></a>4、优化播放端</h3><h4 id="4-1-卡顿与延迟"><a href="#4-1-卡顿与延迟" class="headerlink" title="4.1 卡顿与延迟"></a>4.1 卡顿与延迟</h4><p>​	如果想要让观看端的视频卡顿尽量少，就要尽可能地让 App 缓存足够多的视频数据，以保证它能平安度过这些“饥饿期”，但是 App 缓存太多的音视频数据会引入一个新的问题，即<strong>高延迟</strong>。<strong>延迟和流畅是一架天平的两端</strong>。</p>
<p>​	setAutoAdjustCache自动模式。在该模式下播放器会根据当前网络情况，对延迟进行自动调节（默认情况下播放器会在1秒 - 5秒这个区间内自动调节延迟大小</p>
<h4 id="4-2造成直播视频卡顿的原因主要有设备、视频流、网络这三方面的问题。"><a href="#4-2造成直播视频卡顿的原因主要有设备、视频流、网络这三方面的问题。" class="headerlink" title="4.2造成直播视频卡顿的原因主要有设备、视频流、网络这三方面的问题。"></a>4.2<strong>造成直播视频卡顿的原因主要有设备、视频流、网络这三方面的问题。</strong></h4><p><strong>设备</strong>：</p>
<p>高清视频往往会给硬件带来解码压力</p>
<ul>
<li>降低视频码率，选择流畅或者标清画质进行视频播放；</li>
<li>增大播放器缓冲区，缓解因网络或解码不稳定引起的卡顿。</li>
</ul>
<p><strong>视频流参数配置问题</strong></p>
<ul>
<li>设置合理的码率，帧率，分辨率，关键帧间隔，音视频编码格式等参数；</li>
<li>尽量遵循标准的视频编码方案，流媒体传输协议，对视频流进行采集，编码，解码，播放等操作。</li>
</ul>
<p><strong>上传网络</strong></p>
<p>当主播端网络较差时，会导致推流端上行不稳定，这个时候可以通过 <a href="https://link.zhihu.com/?target=http://www.speedtest.net/">speedtest</a> 进行测速，判断主播端的网络速度</p>
<p><strong>下行网络</strong></p>
<ul>
<li><p>用户通过 <a href="https://link.zhihu.com/?target=http://www.speedtest.net/">speedtest</a> 进行测速，判断终端的网络速度；</p>
</li>
<li><p>用户 ping 播放域名，查看解析到的服务器节点，判断自身IP 到服务器之间是否有延迟过大或者丢包的情况出现；</p>
</li>
<li><p>联系 CDN 厂商排查线路是否有不稳定的现象，也可以通过播放器打点上报，统计所有客户端的整体卡顿率情况，分地区做一些线路和资源的调整和优化。</p>
<img src="/Users/xushuanghui/Library/Application Support/typora-user-images/image-20220830173952538.png" alt="image-20220830173952538" style="zoom:67%;" /></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/20/%E7%9B%B4%E6%92%AD%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88/" data-id="clgovw0nu001vk9d356l420c5" data-title="直播性能指标监控方案" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/03/17/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E9%97%AE%E9%A2%98%E4%B8%8E%E6%B2%BB%E7%90%86/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          多线程问题专项治理
        
      </div>
    </a>
  
  
    <a href="/2021/05/14/%E8%A7%86%E9%A2%91%E7%9B%B8%E5%85%B3%E4%BC%98%E5%8C%96/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">视频相关优化</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xcode/" rel="tag">Xcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cocoaPods/" rel="tag">cocoaPods</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flutter/" rel="tag">flutter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/" rel="tag">iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS-AppDelegate/" rel="tag">iOS AppDelegate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/" rel="tag">强化学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" rel="tag">机器学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%87%8F%E5%8C%96%E4%BA%A4%E6%98%93/" rel="tag">量化交易</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Xcode/" style="font-size: 10px;">Xcode</a> <a href="/tags/cocoaPods/" style="font-size: 10px;">cocoaPods</a> <a href="/tags/flutter/" style="font-size: 10px;">flutter</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/iOS-AppDelegate/" style="font-size: 10px;">iOS AppDelegate</a> <a href="/tags/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">强化学习</a> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 10px;">机器学习</a> <a href="/tags/%E9%87%8F%E5%8C%96%E4%BA%A4%E6%98%93/" style="font-size: 10px;">量化交易</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/04/20/init/">init</a>
          </li>
        
          <li>
            <a href="/2023/01/11/%E5%AE%B9%E5%99%A8%E5%8C%96/">首页容器化</a>
          </li>
        
          <li>
            <a href="/2022/08/14/%E5%8A%A8%E6%80%81%E5%BA%93%E6%87%92%E5%8A%A0%E8%BD%BD/">动态库懒加载</a>
          </li>
        
          <li>
            <a href="/2022/03/17/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E9%97%AE%E9%A2%98%E4%B8%8E%E6%B2%BB%E7%90%86/">多线程问题专项治理</a>
          </li>
        
          <li>
            <a href="/2021/07/20/%E7%9B%B4%E6%92%AD%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88/">直播性能指标监控方案</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 xushuanghui<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>